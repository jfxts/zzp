<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galgame - 完美修复版</title>
    <style>
        /* --- 全局样式 --- */
        body { margin: 0; background: #222; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; user-select: none; }
        #game-container { width: 900px; height: 640px; position: relative; background: #000; box-shadow: 0 0 40px rgba(100, 200, 255, 0.4); overflow: hidden; border-radius: 12px; border: 4px solid #fff; }
        
        /* 背景 */
        #background { width: 100%; height: 100%; position: absolute; z-index: 1; background-size: cover; background-position: center; transition: opacity 0.5s; }
        
        /* 角色 */
        #character { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); height: 90%; transition: all 0.2s ease; z-index: 10; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }

        /* 对话框 */
        #dialogue-box { position: absolute; bottom: 20px; left: 20px; right: 20px; height: 180px; background: rgba(30, 30, 40, 0.9); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 16px; padding: 25px 35px; color: #fff; z-index: 20; cursor: pointer; backdrop-filter: blur(5px); display: none; /* 默认隐藏，开始游戏后显示 */ }
        #name-tag { font-size: 28px; font-weight: bold; color: #ff9a9e; margin-bottom: 12px; display: inline-block; }
        #text-content { font-size: 22px; line-height: 1.5; color: #f0f0f0; }
        
        /* 选项层 */
        #choices-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 30; backdrop-filter: blur(4px); }
        .choice-btn { background: white; border: none; color: #333; padding: 15px 60px; margin: 15px; font-size: 22px; border-radius: 50px; cursor: pointer; width: 500px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.1s; border-left: 10px solid #ff9a9e; }
        .choice-btn:hover { transform: scale(1.05); background: #fff0f5; }

        /* --- 新增：开始界面 --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 100; /* 最高层级，挡住一切 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #title { font-size: 60px; color: white; font-weight: bold; margin-bottom: 50px; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #start-btn {
            padding: 20px 80px; font-size: 30px; background: #fff; border: none; border-radius: 50px;
            color: #764ba2; font-weight: bold; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.1); }

        .cursor::after { content: ' ▼'; animation: blink 1s infinite; color: #ff9a9e; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- 1. 开始界面 (覆盖在最上面) -->
        <div id="start-screen">
            <div id="title">我的 Galgame</div>
            <button id="start-btn" onclick="startGame()">开始游戏</button>
        </div>

        <div id="background"></div>
        <img id="character" src="" style="opacity: 0">
        
        <div id="dialogue-box" onclick="nextStep()">
            <div id="name-tag"></div>
            <div id="text-content"></div>
        </div>
        <div id="choices-overlay"></div>
    </div>

    <script>
        // --- 资源配置 ---
        const assets = {
            bg:     "bg.jpg",
            normal: "normal.png",
            happy:  "happy.png",
            sad:    "sad.png"
        };

        // --- 剧本 ---
        const script = {
            "start": {
                name: "",
                text: "（这是放学后的走廊，夕阳西下……）",
                bg: assets.bg,
                char: null,
                next: "meet"
            },
            "meet": {
                name: "???",
                text: "哎呀，前辈！",
                bg: assets.bg,
                char: assets.normal,
                next: "intro"
            },
            "intro": {
                name: "学妹",
                text: "能在这里遇到你真是太巧了。",
                char: assets.normal,
                next: "question"
            },
            "question": {
                name: "学妹",
                text: "那个……这周末有新电影上映，前辈有空吗？",
                char: assets.normal,
                choices: [
                    { text: "有空啊，一起去吧！", target: "happy_route" },
                    { text: "抱歉，我要在家打游戏。", target: "sad_route" }
                ]
            },
            "happy_route": {
                name: "学妹",
                text: "真的吗？！太棒了！(眼神发光)",
                char: assets.happy,
                next: "happy_end"
            },
            "happy_end": {
                name: "系统",
                text: "【Happy End - 电影院的约定】",
                char: assets.happy,
                next: null
            },
            "sad_route": {
                name: "学妹",
                text: "啊……是、是这样啊。呵呵，你死定了……",
                char: assets.sad,
                next: "sad_end"
            },
            "sad_end": {
                name: "系统",
                text: "【Bad End - 错过的机会】",
                char: assets.sad,
                next: null
            }
        };

        // --- 引擎逻辑 ---
        let currentNode = "start";
        let isTyping = false;
        let fullText = "";
        let charIndex = 0;
        let gameStarted = false; // 增加一个状态标记
        
        const ui = {
            startScreen: document.getElementById('start-screen'), // 获取开始界面
            dialogueBox: document.getElementById('dialogue-box'),
            bg: document.getElementById('background'),
            char: document.getElementById('character'),
            name: document.getElementById('name-tag'),
            text: document.getElementById('text-content'),
            choices: document.getElementById('choices-overlay')
        };

        // 【新增】专门的开始游戏函数
        function startGame() {
            gameStarted = true;
            // 淡出开始界面
            ui.startScreen.style.opacity = 0;
            setTimeout(() => {
                ui.startScreen.style.display = 'none'; // 彻底隐藏
                ui.dialogueBox.style.display = 'block'; // 显示对话框
                renderNode(currentNode); // 渲染第一句
            }, 500);
        }

        function renderNode(nodeId) {
            const node = script[nodeId];
            if (!node) return;

            if(node.bg) ui.bg.style.backgroundImage = `url('${node.bg}')`;

            if (node.char) {
                if(ui.char.getAttribute('src') !== node.char) ui.char.src = node.char;
                ui.char.style.opacity = 1;
            } else {
                ui.char.style.opacity = 0;
            }

            ui.name.innerText = node.name;
            ui.name.style.display = node.name ? "inline-block" : "none";

            fullText = node.text;
            ui.text.innerHTML = "";
            charIndex = 0;
            isTyping = true;
            typeWriter();
        }

        function typeWriter() {
            if (charIndex < fullText.length) {
                ui.text.innerHTML += fullText.charAt(charIndex) === '\n' ? '<br>' : fullText.charAt(charIndex);
                charIndex++;
                setTimeout(typeWriter, 30);
            } else {
                isTyping = false;
                ui.text.classList.add("cursor");
                if (script[currentNode].choices) showChoices(script[currentNode].choices);
            }
        }

        function nextStep() {
            // 如果游戏还没开始，或者正在显示选项，禁止点击生效
            if (!gameStarted) return; 
            
            const node = script[currentNode];
            if (isTyping) {
                charIndex = fullText.length;
                ui.text.innerHTML = fullText;
                isTyping = false;
                ui.text.classList.add("cursor");
                if (node.choices) showChoices(node.choices);
                return;
            }
            if (node.choices) return;
            if (!node.next) {
                if(confirm("剧情结束。重来？")) location.reload();
                return;
            }
            ui.text.classList.remove("cursor");
            currentNode = node.next;
            renderNode(currentNode);
        }

        function showChoices(choices) {
            ui.choices.innerHTML = "";
            ui.choices.style.display = "flex";
            choices.forEach(choice => {
                const btn = document.createElement("button");
                btn.className = "choice-btn";
                btn.innerText = choice.text;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    ui.choices.style.display = "none";
                    currentNode = choice.target;
                    renderNode(currentNode);
                };
                ui.choices.appendChild(btn);
            });
        }
    </script>
</body>
</html>
